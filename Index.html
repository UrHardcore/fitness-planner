<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#22c55e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Rutinas">
<title>Gonza Hard-Fitness Planner ‚Äî Login</title>
<style>
:root{
  --bg:#0b0f14;
  --panel:#11161d;
  --card:#0e141b;
  --text:#e7edf3;
  --muted:#aab4c0;
  --border:#1f2a37;
  --accent:#22c55e;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--text);
  -webkit-tap-highlight-color:transparent;
  min-height:100dvh;
  display:flex;
  justify-content:center;
  align-items:center;
  padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  background-image:url('https://i.ibb.co/0p57Nz3P/wallpaperflare-com-wallpaper.jpg');
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;
}

/* Pantalla de login */
#authScreen {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  background:rgba(17,22,29,.85);
  border:1px solid var(--border);
  border-radius:16px;
  padding:24px;
  max-width:800px;
  width:90%;
  color:#fff;
}
.login-left {
  display:flex;
  justify-content:center;
  align-items:center;
  text-align:center;
  border-right:1px solid var(--border);
  padding-right:20px;
}
.title-container { display:flex; flex-direction:column; align-items:center; gap:10px; }
.logo { width:325px; height:auto; }
.login-left h1 { font-size:28px; line-height:1.2; margin:0; }

.login-right { display:flex; flex-direction:column; gap:10px; justify-content:center; text-align:center; }
input{
  background:var(--card);
  border:1px solid var(--border);
  color:var(--text);
  border-radius:10px;
  padding:10px;
  min-height:44px;
  font-size:16px;
  width:100%;
}
.btn{
  background:transparent;
  border:1px solid var(--border);
  color:var(--text);
  padding:10px 12px;
  border-radius:12px;
  cursor:pointer;
}
.btn:hover{ border-color:var(--accent); }
.btn-accent{ background:var(--accent); border-color:transparent; color:#fff; }

.divider { display:flex; align-items:center; text-align:center; margin:15px 0; color:var(--muted); }
.divider::before, .divider::after { content:''; flex:1; border-bottom:1px solid var(--border); }
.divider:not(:empty)::before { margin-right:.25em; }
.divider:not(:empty)::after { margin-left:.25em; }
.social-soon { color:var(--muted); font-size:14px; text-align:center; margin:15px 0; }

/* Responsivo */
@media (max-width: 720px){
  #authScreen{ grid-template-columns:1fr; padding:16px; }
  .login-left{ border-right:none; border-bottom:1px solid var(--border); padding-right:0; padding-bottom:16px; }
  .logo{ width:260px; }
}
</style>
</head>
<body>

  <!-- √öNICA PANTALLA: LOGIN (sin bot√≥n de modo) -->
  <div id="authScreen">
    <div class="login-left">
      <div class="title-container">
        <img src="https://i.ibb.co/bnRB2Sk/processed-image-3.png" alt="Logo de Gonza Hard-Fitness" class="logo">
        <h1>Gonza Hard-Fitness Planner</h1>
      </div>
    </div>

    <div class="login-right">
      <input type="email" id="email" placeholder="Correo electr√≥nico" autocomplete="username" />
      <input type="password" id="password" placeholder="Contrase√±a" autocomplete="current-password" />

      <div style="display:flex; gap:6px; margin-top:10px; justify-content:center; flex-wrap:wrap;">
        <button class="btn btn-accent" id="loginBtn">Iniciar Sesi√≥n</button>
        <button class="btn" id="registerBtn">Registrarme</button>
      </div>

      <div class="divider">O</div>
      <div class="social-soon">Pr√≥ximamente Inicio de sesi√≥n: Google y Facebook</div>
    </div>
  </div>

  <script type="module">
    // Firebase v12 desde CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserSessionPersistence,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // ‚öôÔ∏è Config de tu proyecto
    const firebaseConfig = {
      apiKey: "AIzaSyBq1nut-QJnpiUbD5nul9Vjkl3ZbV-OFM0",
      authDomain: "fitness-rp.firebaseapp.com",
      projectId: "fitness-rp",
      storageBucket: "fitness-rp.firebasestorage.app",
      messagingSenderId: "512160414081",
      appId: "1:512160414081:web:7d0e16235f29087dc71080"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Persistencia por sesi√≥n (se pierde al cerrar pesta√±a/ventana)
    await setPersistence(auth, browserSessionPersistence).catch(console.error);

    // Cierre de sesi√≥n autom√°tico al cerrar la p√°gina (fallback extra)
    const autoSignOut = () => { if (auth.currentUser) signOut(auth); };
    window.addEventListener('pagehide', autoSignOut);
    window.addEventListener('beforeunload', autoSignOut);

    // Helpers
    const $ = (s) => document.querySelector(s);
    const ADMIN_EMAILS = new Set(["dattdemon@hotmail.com", "gym@gym.com"]);
    const uuid = () =>
      (self.crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : ("log_" + Date.now() + "_" + Math.random().toString(36).slice(2));

    // === Correcciones integradas: perfil+rol y log de login ===
    async function ensureUserProfile(user) {
      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      const role = ADMIN_EMAILS.has(user.email) ? "coach" : "usuario";

      if (!snap.exists()) {
        await setDoc(ref, { email: user.email, role, createdAt: serverTimestamp() }, { merge: true });
      } else {
        // Fuerza el rol correcto por si cambi√≥ el email de admin/no admin
        const current = snap.data()?.role;
        if (role !== current) {
          await setDoc(ref, { role }, { merge: true });
        }
      }
    }

    async function logLogin(user) {
      const userAgent = navigator.userAgent || "unknown";
      await setDoc(doc(db, "logs_logins", uuid()), {
        uid: user.uid,
        email: user.email,
        ua: userAgent,
        ts: serverTimestamp()
      });
    }

    // Botones
    $('#loginBtn').addEventListener('click', async () => {
      const email = $('#email').value.trim();
      const password = $('#password').value;
      if (!email || !password) { alert('Complet√° email y contrase√±a.'); return; }
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert('Error de login: ' + err.message);
      }
    });

    $('#registerBtn').addEventListener('click', async () => {
      const email = $('#email').value.trim();
      const password = $('#password').value;
      if (!email || !password) { alert('Complet√° email y contrase√±a.'); return; }
      try {
        await createUserWithEmailAndPassword(auth, email, password);
      } catch (err) {
        alert('Error de registro: ' + err.message);
      }
    });

    // Redirecci√≥n tras login (solo despu√©s de guardar perfil/rol y log)
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          await ensureUserProfile(user);
          await logLogin(user);
          // üëâ Cambi√° si tu siguiente archivo tiene otro nombre
          window.location.href = "planificador.html";
        } catch (e) {
          console.error("Post-login setup error:", e);
          alert("No se pudo terminar de registrar tu inicio de sesi√≥n.");
        }
      }
    });
  </script>
</body>
</html>
