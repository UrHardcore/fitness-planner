<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#22c55e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Rutinas">
<title>Gonza Hard-Fitness Planner</title>
<style>
:root{
  --bg:#0b0f14;
  --panel:#11161d;
  --card:#0e141b;
  --text:#e7edf3;
  --muted:#aab4c0;
  --border:#1f2a37;
  --accent:#22c55e;
  --danger:#ef4444;
}
body.light-mode{
  --bg:#f3f4f6;
  --panel:#ffffff;
  --card:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --border:#d1d5db;
  --accent:#10b981;
  --danger:#dc2626;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
  background:var(--bg);
  color:var(--text);
  -webkit-tap-highlight-color:transparent;
  padding-top:env(safe-area-inset-top);
  padding-left:env(safe-area-inset-left);
  padding-right:env(safe-area-inset-right);
  height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background-image: url('https://i.ibb.co/0p57Nz3P/wallpaperflare-com-wallpaper.jpg');
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  transition: background-color 0.3s ease, color 0.3s ease;
}

.container{max-width:1100px;margin:0 auto;padding:16px}
header{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
h1{font-size:18px;margin:0}
.btn{background:transparent;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btn:hover{border-color:var(--accent)}
.btn-accent{background:var(--accent);border-color:transparent;color:white}
input,select,textarea{background:var(--card);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px;min-height:44px;font-size:16px}
.grid{display:grid;gap:12px}
@media(min-width:900px){.grid{grid-template-columns:1fr 1.2fr 0.8fr}}
.card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px}
.list{display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto}
.item{display:flex;justify-content:space-between;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:8px}
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
.tab{padding:6px 10px;border:1px solid var(--border);background:var(--card);border-radius:10px;cursor:pointer}
.tab.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
.exercise{border:1px dashed var(--border);border-radius:12px;padding:10px;display:grid;gap:8px}
.ex-row{display:grid;grid-template-columns:1.3fr 1fr 1.2fr .7fr .7fr .9fr .7fr .8fr;gap:6px}
@media(max-width:900px){.ex-row{grid-template-columns:1fr 1fr}}
.footer{margin-top:6px;color:var(--muted);font-size:12px}

/* Estilos para la pantalla de login */
#authScreen {
  display: grid;
  grid-template-columns: 1fr 1fr;
  grid-gap: 20px;
  background: rgba(17, 22, 29, 0.85);
  border-radius: 16px;
  padding: 24px;
  max-width: 800px;
  width: 90%;
  color: white;
}
.login-left {
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  border-right: 1px solid var(--border);
  padding-right: 20px;
}
.title-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
}
.logo {
  width: 325px;
  height: auto;
}
.login-left h1 {
  font-size: 28px;
  line-height: 1.2;
  margin: 0;
}
.login-right {
  display: flex;
  flex-direction: column;
  gap: 10px;
  justify-content: center;
  text-align: center;
}
.divider {
  display: flex;
  align-items: center;
  text-align: center;
  margin: 15px 0;
  color: var(--muted);
}
.divider::before, .divider::after {
  content: '';
  flex: 1;
  border-bottom: 1px solid var(--border);
}
.divider:not(:empty)::before { margin-right: .25em; }
.divider:not(:empty)::after { margin-left: .25em; }
.social-soon {
  color: var(--muted);
  font-size: 14px;
  text-align: center;
  margin: 15px 0;
}
</style>
</head>
<body>
  <div id="authScreen">
    <div class="login-left">
      <div class="title-container">
        <img src="https://i.ibb.co/bnRB2Sk/processed-image-3.png" alt="Logo de Gonza Hard-Fitness" class="logo">
        <h1>Gonza Hard-Fitness Planner</h1>
      </div>
    </div>
    <div class="login-right">
      <input type="email" id="email" placeholder="Correo electr√≥nico">
      <input type="password" id="password" placeholder="Contrase√±a">
      <div style="display: flex; gap: 6px; margin-top: 10px; justify-content: center;">
        <button class="btn btn-accent" id="loginBtn">Iniciar Sesi√≥n</button>
        <button class="btn" id="registerBtn">Reg√≠strarme</button>
      </div>
      <div class="divider">O</div>
      <div class="social-soon">Pr√≥ximamente Inicio de sesi√≥n: Google y Facebook</div>
      <!-- Bot√≥n opcional de cerrar sesi√≥n visible tambi√©n en la pantalla de login -->
      <button class="btn" id="logoutFromAuthBtn" style="margin-top:8px;">Cerrar sesi√≥n</button>
    </div>
  </div>

  <div class="container" id="mainApp" style="display:none;">
    <header>
      <h1>Gonza Hard-Fitness Planner</h1>
      <div style="display:flex;gap:6px;">
        <span id="userName" style="align-self:center;font-weight:bold;"></span>
        <button class="btn" id="exportBtn">Exportar</button>
        <button class="btn" id="printBtn">Imprimir/PDF</button>
        <!-- Renombrado a Cerrar sesi√≥n -->
        <button class="btn" id="logoutBtn" title="Cerrar la sesi√≥n actual" style="color:var(--danger);border-color:var(--danger)">Cerrar sesi√≥n</button>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h3>Mi Rutina</h3>
        <div id="title" style="font-size:18px;font-weight:bold;margin-top:10px;"></div>
        <div id="subtitle" style="color:var(--muted);margin-top:4px;"></div>
        <div style="display:flex;gap:6px;align-items:center;margin-top:10px;">
          <select id="weekSelect"></select>
          <button class="btn" id="newWeek">Nueva semana</button>
        </div>
        <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap">
          <label>Desde <input id="weekFrom" type="date"></label>
          <label>Hasta <input id="weekTo" type="date"></label>
        </div>
        <div id="daysTabs" class="tabs"></div>
        <div id="dayEditor"></div>
      </section>

      <section class="card">
        <h3>Resumen</h3>
        <label>Adherencia % <input id="sumAdh" type="number" min="0" max="100"></label>
        <label>NEAT/Pasos <input id="sumNeat" type="number" min="0"></label>
        <label>Sensaci√≥n (1‚Äì10) <input id="sumSens" type="number" min="1" max="10"></label>
        <label>Sue√±o (h) <input id="sumSleep" type="number" step="0.1" min="0"></label>
        <label>Estr√©s (1‚Äì5) <input id="sumStress" type="number" min="1" max="5"></label>
        <label>Comentarios <textarea id="sumNotes"></textarea></label>
        <div class="footer">Datos guardados en Firebase</div>
      </section>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // Reemplaza con tu configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBq1nut-QJnpiUbD5nul9Vjkl3ZbV-OFM0",
      authDomain: "fitness-rp.firebaseapp.com",
      projectId: "fitness-rp",
      storageBucket: "fitness-rp.firebasestorage.app",
      messagingSenderId: "512160414081",
      appId: "1:512160414081:web:7d0e16235f29087dc71080"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $=s=>document.querySelector(s);const $$=s=>Array.from(document.querySelectorAll(s));
    const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
    const today=()=>new Date().toISOString().slice(0,10);
    let state={alumnos:[]};
    let cur={aid:null,wid:null,dia:'lunes'};
    const DIAS=['lunes','martes','miercoles','jueves','viernes','sabado','domingo'];
    
    // Funcionalidad del modo oscuro/claro (los botones pueden agregarse m√°s tarde si quer√©s)
    const toggleButtons = $$('#modeToggleBtn, #modeToggleBtn2');
    function toggleMode() {
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        toggleButtons.forEach(btn => btn.textContent = isLight ? '‚òÄÔ∏è' : 'üåô');
    }
    toggleButtons.forEach(btn => btn.addEventListener('click', toggleMode));
    if (localStorage.getItem('theme') === 'light') {
        document.body.classList.add('light-mode');
        toggleButtons.forEach(btn => btn.textContent = '‚òÄÔ∏è');
    }

    function demo(nombre){const aid=uid(), wid=uid(); return {id:aid,nombre, semanas:[{id:wid,titulo:'Semana 1',desde:today(),hasta:today(),dias:baseDias(),resumen:baseRes()}]};}
    function baseDias(){const d={lunes:[],martes:[],miercoles:[],jueves:[],viernes:[],sabado:[],domingo:[]}; d.lunes.push(exBase('Pecho','Hipertrofia','Press banca',4,'8-12','',90,7,'')); return d;}
    function exBase(actividad='',modalidad='',ejercicio='',series=3,reps='10',tiempo='',descanso=60,rpe=7,notas=''){return {id:uid(),actividad,modalidad,ejercicio,series,reps,tiempo,descanso,rpe,notas};}
    function baseRes(){return {adh:0,neat:0,sens:5,sleep:0,stress:3,notes:''};}

    // Guardar en Firebase
    async function save(){
      if(cur.aid){
        const docRef = doc(db, "alumnos", cur.aid);
        const alumnoActual = getA();
        if (alumnoActual) {
          await setDoc(docRef, { ...alumnoActual, id: cur.aid });
        }
      }
      renderStudents();
    }

    // Render
    function renderStudents(){
      const a=getA();
      if(a){
        $('#title').textContent='Rutina de '+a.nombre;
        $('#subtitle').textContent='Semana ' + (a.semanas.findIndex(w => w.id === cur.wid) + 1);
        renderWeeks();
      }
    }
    
    function selectStudent(id){
      cur.aid=id;
      const a=getA();
      if (a) {
        $('#userName').textContent = a.nombre;
        cur.wid = a.semanas[0].id;
        renderStudents();
      }
    }

    function renderWeeks(){
      const a=getA(); const sel=$('#weekSelect'); sel.innerHTML=''; a.semanas.forEach(w=>{const o=document.createElement('option');o.value=w.id;o.textContent=w.titulo;sel.appendChild(o)});
      sel.value=cur.wid; sel.onchange=()=>{cur.wid=sel.value; renderWeek();};
      $('#newWeek').onclick=()=>{const w={id:uid(),titulo:'Semana '+(a.semanas.length+1),desde:today(),hasta:today(),dias:baseDias(),resumen:baseRes()}; a.semanas.unshift(w); cur.wid=w.id; save(); renderWeeks();};
      renderWeek();
    }

    function renderWeek(){
      const w=getW(); $('#weekFrom').value=w.desde||''; $('#weekTo').value=w.hasta||'';
      $('#weekFrom').onchange=e=>{w.desde=e.target.value; save();}; $('#weekTo').onchange=e=>{w.hasta=e.target.value; save();};
      renderTabs(); renderDay();
      $('#sumAdh').value=w.resumen.adh||0; $('#sumNeat').value=w.resumen.neat||0; $('#sumSens').value=w.resumen.sens||5; $('#sumSleep').value=w.resumen.sleep||0; $('#sumStress').value=w.resumen.stress||3; $('#sumNotes').value=w.resumen.notes||'';
      ['sumAdh','sumNeat','sumSens','sumSleep','sumStress','sumNotes'].forEach(id=>{$('#'+id).oninput=()=>{const r=w.resumen; r.adh=+$('#sumAdh').value||0; r.neat=+$('#sumNeat').value||0; r.sens=+$('#sumSens').value||5; r.sleep=+$('#sumSleep').value||0; r.stress=+$('#sumStress').value||3; r.notes=$('#sumNotes').value; save();};});
    }

    function renderTabs(){
      const wrap=$('#daysTabs'); wrap.innerHTML=''; DIAS.forEach(d=>{const b=document.createElement('button'); b.className='tab'+(cur.dia===d?' active':''); b.textContent=d[0].toUpperCase()+d.slice(1); b.onclick=()=>{cur.dia=d; renderTabs(); renderDay();}; wrap.appendChild(b);});}
    
    function renderDay(){
      const w=getW(), d=cur.dia, cont=$('#dayEditor'); cont.innerHTML='';
      (w.dias[d]||[]).forEach((ex,i)=>{cont.appendChild(renderExercise(ex,i,w,d));});
      const add=document.createElement('div'); const btn=document.createElement('button'); btn.className='btn btn-accent'; btn.textContent='Agregar ejercicio'; btn.onclick=()=>{w.dias[d].push(exBase()); save(); renderDay();}; add.appendChild(btn); cont.appendChild(add);
    }
    
    function renderExercise(ex,idx,w,d){
      const el=document.createElement('div'); el.className='exercise';
      el.innerHTML=`<div class="ex-row">
        <input placeholder="Actividad/Grupo" value="${ex.actividad||''}" data-k="actividad">
        <input placeholder="Modalidad" value="${ex.modalidad||''}" data-k="modalidad">
        <input placeholder="Ejercicio" value="${ex.ejercicio||''}" data-k="ejercicio">
        <input type="number" min="0" placeholder="Series" value="${ex.series||0}" data-k="series">
        <input placeholder="Reps" value="${ex.reps||''}" data-k="reps">
        <input placeholder="Tiempo (mm:ss)" value="${ex.tiempo||''}" data-k="tiempo">
        <input type="number" min="0" placeholder="Descanso (s)" value="${ex.descanso||0}" data-k="descanso">
        <input type="number" min="1" max="10" placeholder="RPE" value="${ex.rpe||7}" data-k="rpe">
      </div>
      <textarea placeholder="Notas" data-k="notas">${ex.notas||''}</textarea>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn" data-act="up">‚Üë</button>
        <button class="btn" data-act="down">‚Üì</button>
        <button class="btn" data-act="dup">Duplicar</button>
        <button class="btn" style="border-color:var(--danger);color:var(--danger)" data-act="del">Eliminar</button>
        <button class="btn" data-act="timer">Iniciar descanso</button>
      </div>`;
      el.querySelectorAll('[data-k]').forEach(inp=>{inp.oninput=()=>{const k=inp.dataset.k; ex[k]= (inp.type==='number')? Number(inp.value||0) : inp.value; save();};});
      el.querySelector('[data-act="up"]').onclick=()=>{const arr=w.dias[d]; if(idx>0){[arr[idx-1],arr[idx]]=[arr[idx],arr[idx-1]]; save(); renderDay();}};
      el.querySelector('[data-act="down"]').onclick=()=>{const arr=w.dias[d]; if(idx<arr.length-1){[arr[idx+1],arr[idx]]=[arr[idx],arr[idx+1]]; save(); renderDay();}};
      el.querySelector('[data-act="dup"]').onclick=()=>{const arr=w.dias[d]; const c=JSON.parse(JSON.stringify(ex)); c.id=uid(); arr.splice(idx+1,0,c); save(); renderDay();};
      el.querySelector('[data-act="del"]').onclick=()=>{if(confirm('¬øEliminar ejercicio?')){w.dias[d]=w.dias[d].filter(x=>x.id!==ex.id); save(); renderDay();}};
      el.querySelector('[data-act="timer"]').onclick=()=>{let secs=Number(ex.descanso||60); const id=setInterval(()=>{if(secs<=0){clearInterval(id); alert('¬°Descanso finalizado!');} else {document.title='‚è± '+secs+'s'; secs--; }},1000);};
      return el;
    }

    const getA=()=>state.alumnos.find(a=>a.id===cur.aid)||null;
    const getW=()=>{const a=getA(); return a? a.semanas.find(w=>w.id===cur.wid):null;};

    // Export / Print
    $('#exportBtn').onclick=()=>{const blob=new Blob([JSON.stringify(getA(),null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mi_rutina.json'; a.click(); URL.revokeObjectURL(a.href);};
    $('#printBtn').onclick=()=>window.print();
    
    // Auth
    $('#loginBtn').onclick = () => {
      const email = $('#email').value;
      const password = $('#password').value;
      signInWithEmailAndPassword(auth, email, password)
        .catch((error) => { alert('Error de login: ' + error.message); });
    };

    $('#registerBtn').onclick = () => {
      const email = $('#email').value;
      const password = $('#password').value;
      createUserWithEmailAndPassword(auth, email, password)
        .catch((error) => { alert('Error de registro: ' + error.message); });
    };

    // NUEVO: cerrar sesi√≥n desde cualquier pantalla
    const doLogout = () => {
      signOut(auth)
        .then(() => {
          alert('Sesi√≥n cerrada.');
          window.location.href = 'Prueba2_redir_lite.html'; // volver al login
        })
        .catch((error) => {
          alert('No se pudo cerrar sesi√≥n: ' + error.message);
        });
    };

    $('#logoutBtn').onclick = doLogout;
    $('#logoutFromAuthBtn').onclick = doLogout;

    // Redirecci√≥n al planner si ya est√° logueado
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        window.location.replace('planificador_rutinas_lite.html');
        return;
      } else {
        $('#authScreen').style.display = 'grid';
        $('#mainApp').style.display = 'none';
      }
    });
  </script>
</body>
</html>
